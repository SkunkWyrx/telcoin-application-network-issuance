# Codebase Overview

This README provides a comprehensive overview of the codebase, detailing the various calculators and their associated data sources. For system diagrams and in-depth documentation on the calculators themselves, please refer to the specific calculator specification markdown files located in this directory.

## **Architecture Overview**

The codebase is primarily divided into two components: **calculators** and **data sources**. Data sources are inputs for calculators, which are tasked with determining allocations for specific metrics or programs.

The `src/app.ts` file functions as the application's main entry point. It initializes data sources, passes them to calculators, executes the calculators, and ultimately saves the results to disk.

## **Classes**

### **ExecutorRegistry**

The `ExecutorRegistry` class is responsible for tracking each developer's executor EOAs (Externally Owned Accounts). A basic implementation, `LocalFileExecutorRegistry`, reads from a local file. This class can also be implemented to read from the blockchain or alternative sources beyond a local file. The registry should consider executors as they exist at the beginning of the period and may eventually include a blacklist to exclude certain jurisdictions from issuance to comply with local regulations.

### **BlocksDatabase**

`BlocksDatabase` is an implementation of the `BaseDatabase` class, specifically tailored for EVM (Ethereum Virtual Machine) blocks. It offers functionality to fetch and store block data on disk, with persistence to reduce RPC usage and enhance performance. Databases abstracting dynamically progressing sources, such as blockchains generating new blocks or newly updated files, must be synchronized using the `sync()` function.

### **TokenTransferHistory**

The `TokenTransferHistory` class monitors all token transfers within a specified `[startBlock:endBlock]` range. It employs Viem event parsing to fetch transfers, abstracting them into an intuitive data type that includes transaction hashes for cross-referencing with other on-chain data if needed.

### **SimplePlugin**

The `SimplePlugin` class retrieves `claimableIncreased` events from a `SimplePlugin` smart contract, a modular extension to the Telcoin `StakingModule` that provides opinionated implementations of staking schemas. These events are utilized by the `DeveloperIncentivesCalculator`.

### **UserRegistry**

The `UserRegistry` class maintains records of users by storing their off-chain user IDs, EOA addresses, referral types, and both referrer and referee IDs. The registry should consider users as they exist at the beginning of the period.

### **ReferralRegistry**

The `ReferralRegistry` class manages referral relationships between users. Currently, it employs a single implementation, the `LocalFileReferralsRegistry`, which reads from a local file generated by the TAN backend. This implementation could be extended to read from the blockchain or other sources.

## **Notes and Caveats**

- **Checksum Encoding:** All addresses in the configuration file must be checksum encoded. Use Viem's `getAddress` function for this purpose.
- **Local File Data Sources:** Some data sources are simply read from a local file, including `LocalFileExecutorRegistry`, `LocalFileReferralsRegistry`, and `LocalFileUserRegistry`.
- **Data Timing:** Concrete implementations of `BaseExecutorRegistry`, `BaseUserRegistry`, and `BaseReferralsRegistry` should reflect data as it exists at the beginning of the period.
- **Multi-Chain User Data:** The `BaseUserRegistry` expects users to exist on multiple chains. Since wallets may have different addresses across chains, each `User` has an ID. The `User` data structure contains all necessary information to establish the full graph of referral relationships. For convenience, the `BaseReferralsRegistry` solely tracks referral relationships in terms of user IDs.
- **Network Configuration:** The Telcoin Network is not yet configured, pending the mainnet beta launch and migration. Refer to comments in `src/config.ts` and `src/app.ts` for more information.
- **Starting Point:** Reading through `src/app.ts` is a recommended starting point for understanding the codebase.
